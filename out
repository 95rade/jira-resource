#!/usr/bin/node

'use strict'

// This must be set BEFORE out.js is required for the debug info to show up
process.env.DEBUG='*';

const fs = require('fs');
const out = require('./src/out.js');

process.stdin.resume();
process.stdin.setEncoding('utf8');
process.stdin.on('data', function(data) {
    out(JSON.parse(data), (error, result) => {
        if (error) {
            process.stderr.write(error.message);
            process.exit(1);
        }

        var readdir = require('fs').readdir;


        console.log('Getting number of fds')
        readdir('/proc/self/fd', function(err, list) {
            if (err) throw err;
            console.log(list.length);
        });

        process.oob1 = fs.createWriteStream(null, { fd: 4 });
        process.oob1.write(result);
    });
});